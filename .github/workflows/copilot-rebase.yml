name: Copilot Rebase Helper

# This workflow helps Copilot PRs stay up-to-date with master
# Disabled auto-trigger to prevent CI loops - use workflow_dispatch manually

on:
  # push:
  #   branches: [master]  # Disabled - causes CI loops
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to rebase (optional, rebases all Copilot PRs if empty)'
        required: false
        type: number

permissions:
  contents: write
  pull-requests: write

jobs:
  rebase-copilot-prs:
    runs-on: ubuntu-latest

    steps:
      - name: Generate App Token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Find Copilot PRs
        id: find-prs
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const inputPR = '${{ github.event.inputs.pr_number }}';

            if (inputPR) {
              // Rebase specific PR
              core.setOutput('prs', JSON.stringify([parseInt(inputPR)]));
              return;
            }

            // Find all Copilot PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const copilotPRs = prs.filter(pr =>
              pr.head.ref.startsWith('copilot/') ||
              pr.user.login === 'copilot[bot]' ||
              pr.user.login === 'Copilot'
            );

            const prNumbers = copilotPRs.map(pr => pr.number);
            console.log(`Found ${prNumbers.length} Copilot PRs: ${prNumbers.join(', ')}`);
            core.setOutput('prs', JSON.stringify(prNumbers));

      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ steps.generate-token.outputs.token }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "flip-devops-bot[bot]"
          git config user.email "flip-devops-bot[bot]@users.noreply.github.com"

      - name: Rebase PRs
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const prNumbers = JSON.parse('${{ steps.find-prs.outputs.prs }}');

            for (const prNumber of prNumbers) {
              try {
                // Get PR details
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });

                const branch = pr.head.ref;
                console.log(`Rebasing PR #${prNumber} (${branch}) on master...`);

                // Check if rebase is needed
                const { data: comparison } = await github.rest.repos.compareCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: branch,
                  head: 'master'
                });

                if (comparison.behind_by === 0) {
                  console.log(`PR #${prNumber} is already up-to-date`);
                  continue;
                }

                console.log(`PR #${prNumber} is ${comparison.behind_by} commits behind master`);

                // Try to update branch using GitHub API (merge method)
                try {
                  await github.rest.pulls.updateBranch({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber
                  });
                  console.log(`Successfully updated PR #${prNumber}`);
                } catch (mergeError) {
                  // If merge update fails, leave a comment for manual intervention
                  console.log(`Could not auto-update PR #${prNumber}: ${mergeError.message}`);

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    body: `⚠️ This PR is behind master and couldn't be automatically updated. Please rebase manually:\n\n\`\`\`bash\ngit fetch origin\ngit rebase origin/master\ngit push --force-with-lease\n\`\`\`\n\n_Auto-comment by rebase helper workflow_`
                  });
                }
              } catch (error) {
                console.error(`Error processing PR #${prNumber}:`, error.message);
              }
            }

      - name: Summary
        if: always()
        run: |
          echo "### Copilot Rebase Helper Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Processed PRs: ${{ steps.find-prs.outputs.prs }}" >> $GITHUB_STEP_SUMMARY
