name: Copilot Review Feedback

on:
  # Trigger after CI workflow completes - this runs with repo permissions
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check'
        required: true

permissions:
  pull-requests: write
  issues: write

jobs:
  forward-review-to-agent:
    runs-on: ubuntu-latest
    # Only run if CI passed (or manual trigger)
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Get PR number
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            # Get PR from workflow run
            HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
            PR_NUMBER=$(gh api repos/${{ github.repository }}/commits/$HEAD_SHA/pulls --jq '.[0].number // empty')
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "has_pr=true" >> $GITHUB_OUTPUT

          # Check if PR is from Copilot
          PR_AUTHOR=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER --jq '.user.login')
          PR_AUTHOR_LOWER=$(echo "$PR_AUTHOR" | tr '[:upper:]' '[:lower:]')
          HEAD_REF=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER --jq '.head.ref')
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT

          # Check if Copilot PR (by author or branch name)
          if [[ "$PR_AUTHOR_LOWER" == *"copilot"* ]] || [[ "$HEAD_REF" == copilot/* ]]; then
            echo "is_copilot_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_copilot_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for unresolved review comments
        if: steps.pr-info.outputs.has_pr == 'true' && steps.pr-info.outputs.is_copilot_pr == 'true'
        id: check-comments
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          # Get timestamp of Copilot's last "addressed" response
          COPILOT_ADDRESSED_AT=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --jq '[.[] | select(.user.login | test("copilot"; "i")) | select(.body | test("addressed|no further action|complete"; "i"))] | last | .created_at // empty')

          echo "Copilot last addressed at: $COPILOT_ADDRESSED_AT"

          # Get review comments from Copilot reviewer that have suggestions
          # Only count comments AFTER Copilot's last "addressed" response
          if [ -n "$COPILOT_ADDRESSED_AT" ]; then
            COMMENTS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
              --jq --arg since "$COPILOT_ADDRESSED_AT" '[.[] | select(.user.login | test("copilot"; "i")) | select(.created_at > $since) | {path: .path, line: .line, body: .body, created_at: .created_at}]')
          else
            COMMENTS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
              --jq '[.[] | select(.user.login | test("copilot"; "i")) | {path: .path, line: .line, body: .body, created_at: .created_at}]')
          fi

          COMMENT_COUNT=$(echo "$COMMENTS" | jq 'length')
          echo "Found $COMMENT_COUNT new review comments"

          # Check if we already notified about these (avoid spam)
          LAST_COMMENT=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --jq '[.[] | select(.body | contains("implement these suggestions"))] | last // empty')

          if [ -n "$LAST_COMMENT" ] && [ "$COMMENT_COUNT" -gt 0 ]; then
            LAST_NOTIFY=$(echo "$LAST_COMMENT" | jq -r '.created_at // empty')
            LAST_REVIEW_COMMENT=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
              --jq '[.[] | select(.user.login | test("copilot"; "i"))] | last | .created_at // empty')

            if [ -n "$LAST_NOTIFY" ] && [ -n "$LAST_REVIEW_COMMENT" ]; then
              if [[ "$LAST_NOTIFY" > "$LAST_REVIEW_COMMENT" ]]; then
                echo "Already notified about these comments"
                echo "should_notify=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi

          if [ "$COMMENT_COUNT" -gt 0 ]; then
            echo "should_notify=true" >> $GITHUB_OUTPUT
            echo "count=$COMMENT_COUNT" >> $GITHUB_OUTPUT

            # Format for agent
            FORMATTED=$(echo "$COMMENTS" | jq -r '.[] | "- \(.path):\(.line) - \(.body | split("\n")[0])"')
            echo "formatted<<EOF" >> $GITHUB_OUTPUT
            echo "$FORMATTED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "should_notify=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Copilot agent to implement suggestions
        if: steps.check-comments.outputs.should_notify == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          cat <<'COMMENT_EOF' > /tmp/comment.md
          @copilot The Copilot code reviewer left suggestions. Please implement these code review suggestions and push a commit.

          _Auto-forwarded from Copilot code review_
          COMMENT_EOF

          gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body-file /tmp/comment.md
          echo "Notified Copilot to implement suggestions on PR #$PR_NUMBER"

      - name: Summary
        run: |
          echo "### Copilot Review Feedback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.pr-info.outputs.has_pr }}" != "true" ]; then
            echo "ðŸ“­ No PR found for this commit" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.pr-info.outputs.is_copilot_pr }}" != "true" ]; then
            echo "â­ï¸ PR #${{ steps.pr-info.outputs.number }} is not a Copilot PR (author: ${{ steps.pr-info.outputs.author }})" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-comments.outputs.should_notify }}" == "true" ]; then
            echo "âœ… Forwarded suggestions to Copilot on PR #${{ steps.pr-info.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ¨ No new suggestions to forward on PR #${{ steps.pr-info.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          fi
