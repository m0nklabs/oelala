name: Auto-trigger Copilot Workflows

on:
  schedule:
    # Run every 2 minutes to quickly handle pending workflows
    - cron: "*/2 * * * *"
  workflow_dispatch:

jobs:
  auto-trigger:
    name: Trigger workflows for blocked Copilot PRs
    runs-on: ubuntu-latest
    steps:
      - name: Trigger workflows via dispatch (bypasses approval)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Checking for action_required workflow runs from Copilot..."

          # Get blocked runs
          BLOCKED=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '[.workflow_runs[] | select(.conclusion == "action_required") | select(.actor.login == "Copilot" or .actor.login == "copilot-swe-agent") | {id: .id, name: .name, branch: .head_branch, workflow_id: .workflow_id}]' \
            2>/dev/null || echo "[]")

          COUNT=$(echo "$BLOCKED" | jq 'length')
          if [ "$COUNT" -eq 0 ]; then
            echo "No blocked Copilot workflow runs found."
            exit 0
          fi

          echo "Found $COUNT blocked runs"

          # Get unique branches with blocked workflows
          BRANCHES=$(echo "$BLOCKED" | jq -r '[.[].branch] | unique | .[]')

          for BRANCH in $BRANCHES; do
            echo "Triggering CI for branch: $BRANCH"

            # Check if there's already a REAL running/queued CI for this branch
            # Exclude action_required (those are blocked and won't run)
            RUNNING=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq "[.workflow_runs[] | select(.head_branch == \"$BRANCH\") | select(.status == \"in_progress\" or .status == \"queued\") | select(.conclusion != \"action_required\")] | length" \
              2>/dev/null || echo "0")

            if [ "$RUNNING" -gt 0 ]; then
              echo "  Already has $RUNNING running workflows, skipping"
              continue
            fi

            # Also check for recently triggered dispatch runs (within last 5 min)
            RECENT=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq "[.workflow_runs[] | select(.head_branch == \"$BRANCH\") | select(.event == \"workflow_dispatch\") | select(.conclusion == \"success\" or .status == \"in_progress\" or .status == \"queued\")] | .[0:1] | length" \
              2>/dev/null || echo "0")

            if [ "$RECENT" -gt 0 ]; then
              echo "  Recent dispatch run exists, skipping"
              continue
            fi

            # Trigger CI via workflow_dispatch (bypasses first-time contributor check)
            gh api -X POST repos/${{ github.repository }}/actions/workflows/ci.yml/dispatches \
              -f ref="$BRANCH" 2>&1 || echo "  Failed to trigger CI for $BRANCH"

            # Also trigger CodeQL and Secret Scan
            gh api -X POST repos/${{ github.repository }}/actions/workflows/codeql.yml/dispatches \
              -f ref="$BRANCH" 2>&1 || true
            gh api -X POST repos/${{ github.repository }}/actions/workflows/gitleaks.yml/dispatches \
              -f ref="$BRANCH" 2>&1 || true

            echo "  Triggered workflows for $BRANCH"
          done

          echo "Done."
